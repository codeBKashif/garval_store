{% extends "templates/includes/base.html" %}

{% block title %}{{ _("My Account") }} - Finca Garval{% endblock %}

{% block body_class %}account-page{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header" style="height: 200px;">
    <div class="page-header-bg">
        <img src="/assets/garval_store/images/shop-header.jpg" alt="My Account">
        <div class="page-header-overlay"></div>
    </div>
    <div class="page-header-content">
        <h1 class="page-title" data-i18n="account.title">
            {{ _("My Account") }}
        </h1>
    </div>
</section>

<!-- Account Section -->
<section class="account-container">
    <div class="container">
        <div class="account-grid">
            <!-- Sidebar -->
            <div class="account-sidebar">
                <div style="text-align: center; margin-bottom: var(--spacing-xl);">
                    <div style="width: 80px; height: 80px; background: var(--color-gray-200); border-radius: 50%; margin: 0 auto var(--spacing-md); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user" style="font-size: var(--font-size-2xl); color: var(--color-text-muted);"></i>
                    </div>
                    <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-xs);">
                        {{ customer.customer_name if customer else frappe.session.user }}
                    </h3>
                    <p style="font-size: var(--font-size-sm); color: var(--color-text-muted);">
                        {{ frappe.session.user }}
                    </p>
                </div>

                <ul class="account-menu">
                    <li>
                        <a href="#orders" class="active" onclick="showSection('orders', this)">
                            <i class="fas fa-shopping-bag"></i>
                            {{ _("My Orders") }}
                        </a>
                    </li>
                    <li>
                        <a href="#profile" onclick="showSection('profile', this)">
                            <i class="fas fa-user-edit"></i>
                            {{ _("My Profile") }}
                        </a>
                    </li>
                    <li>
                        <a href="#addresses" onclick="showSection('addresses', this)">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ _("Addresses") }}
                        </a>
                    </li>
                    <li>
                        <a href="/logout" style="color: var(--color-error);">
                            <i class="fas fa-sign-out-alt"></i>
                            {{ _("Logout") }}
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Content -->
            <div class="account-content">
                <!-- Orders Section -->
                <div id="orders-section" class="account-section-content">
                    <h2 class="account-section-title">
                        <i class="fas fa-shopping-bag"></i>
                        {{ _("My Orders") }}
                    </h2>

                    {% if orders %}
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>{{ _("Order") }}</th>
                                <th>{{ _("Date") }}</th>
                                <th>{{ _("Status") }}</th>
                                <th>{{ _("Total") }}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr>
                                <td><strong>{{ order.name }}</strong></td>
                                <td>{{ order.transaction_date }}</td>
                                <td>
                                    <span class="order-status {{ order.status|lower|replace(' ', '-') }}">
                                        {{ order.status }}
                                    </span>
                                </td>
                                <td>{{ currency_symbol }}{{ "%.2f"|format(order.grand_total) }}</td>
                                <td>
                                    {% if order.status == 'To Pay' %}
                                    <button onclick="payNow('{{ order.name }}')" class="btn btn-primary" style="padding: 5px 10px; font-size: var(--font-size-xs);">
                                        <i class="fas fa-credit-card"></i> {{ _("Pay Now") }}
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state" style="padding: var(--spacing-2xl);">
                        <div class="empty-state-icon">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <h3 class="empty-state-title">
                            {{ _("You have no orders yet") }}
                        </h3>
                        <p class="empty-state-description">
                            {{ _("When you place an order, it will appear here.") }}
                        </p>
                        <a href="/shop" class="btn btn-primary">
                            {{ _("Go to Shop") }}
                        </a>
                    </div>
                    {% endif %}
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="account-section-content" style="display: none;">
                    <h2 class="account-section-title">
                        <i class="fas fa-user-edit"></i>
                        {{ _("My Profile") }}
                    </h2>

                    <form id="profileForm">
                        <input type="hidden" name="csrf_token" value="{{ frappe.session.csrf_token }}">

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="profile_name">
                                    {{ _("Full Name") }}
                                </label>
                                <input type="text" id="profile_name" name="full_name" class="form-control"
                                       value="{{ customer.customer_name if customer else '' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="profile_email">
                                    {{ _("Email") }}
                                </label>
                                <input type="email" id="profile_email" name="email" class="form-control"
                                       value="{{ frappe.session.user }}" readonly style="background: var(--color-gray-100);">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="profile_phone">
                                    {{ _("Phone") }}
                                </label>
                                <input type="tel" id="profile_phone" name="phone" class="form-control"
                                       value="{{ customer.mobile_no if customer else '' }}">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            {{ _("Save Changes") }}
                        </button>
                    </form>

                    <hr style="margin: var(--spacing-2xl) 0;">

                    <h3 style="margin-bottom: var(--spacing-lg);">{{ _("Change Password") }}</h3>

                    <form id="passwordForm">
                        <input type="hidden" name="csrf_token" value="{{ frappe.session.csrf_token }}">

                        <div class="form-group">
                            <label class="form-label" for="current_password">
                                {{ _("Current Password") }}
                            </label>
                            <input type="password" id="current_password" name="current_password" class="form-control" required>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="new_password">
                                    {{ _("New Password") }}
                                </label>
                                <input type="password" id="new_password" name="new_password" class="form-control" required minlength="8">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="confirm_new_password">
                                    {{ _("Confirm New Password") }}
                                </label>
                                <input type="password" id="confirm_new_password" name="confirm_new_password" class="form-control" required minlength="8">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-outline">
                            {{ _("Change Password") }}
                        </button>
                    </form>
                </div>

                <!-- Addresses Section -->
                <div id="addresses-section" class="account-section-content" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                        <h2 class="account-section-title" style="margin: 0;">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ _("My Addresses") }}
                        </h2>
                        <button onclick="openAddressModal()" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            {{ _("New Address") }}
                        </button>
                    </div>

                    <div id="addressesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-lg);">
                        {% if addresses %}
                            {% for address in addresses %}
                            <div class="address-card" data-address-id="{{ address.name }}" style="background: var(--color-gray-100); padding: var(--spacing-lg); border-radius: var(--radius-md); display: flex; flex-direction: column; height: 100%;">
                                <div style="flex: 1;">
                                    <h4 style="margin-bottom: var(--spacing-sm);">{{ address.address_title }}</h4>
                                    <p style="color: var(--color-text-light); font-size: var(--font-size-sm); line-height: 1.6;">
                                        {{ address.address_line1 }}<br>
                                        {% if address.address_line2 %}{{ address.address_line2 }}<br>{% endif %}
                                        {{ address.city }}, {{ address.state }} {{ address.pincode }}<br>
                                        {{ address.country }}
                                        {% if address.phone %}<br>{{ _("Tel:") }} {{ address.phone }}{% endif %}
                                    </p>
                                </div>
                                <div style="margin-top: var(--spacing-md); display: flex; gap: var(--spacing-sm);">
                                    <button onclick="editAddress('{{ address.name }}')" class="btn btn-outline" style="padding: 5px 10px; font-size: var(--font-size-xs); flex: 1;">
                                        <i class="fas fa-edit"></i>
                                        {{ _("Edit") }}
                                    </button>
                                    <button onclick="deleteAddress('{{ address.name }}')" class="btn btn-outline" style="padding: 5px 10px; font-size: var(--font-size-xs); color: var(--color-error); border-color: var(--color-error);">
                                        <i class="fas fa-trash"></i>
                                        {{ _("Delete") }}
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="empty-state" style="padding: var(--spacing-2xl); grid-column: 1 / -1;">
                            <div class="empty-state-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <h3 class="empty-state-title">
                                {{ _("You have no saved addresses") }}
                            </h3>
                            <p class="empty-state-description">
                                {{ _("Add an address to make future purchases easier.") }}
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Address Modal -->
<div id="addressModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: var(--spacing-2xl); border-radius: var(--radius-lg); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3 id="addressModalTitle" style="margin-bottom: var(--spacing-lg);">
            {{ _("New Address") }}
        </h3>

        <form id="addressForm">
            <input type="hidden" name="csrf_token" value="{{ frappe.session.csrf_token }}">
            <input type="hidden" id="address_id" name="address_id" value="">

            <div class="form-group">
                <label class="form-label" for="address_title">
                    {{ _("Address Title") }} *
                </label>
                <input type="text" id="address_title" name="address_title" class="form-control" required
                       placeholder="{{ _('E.g: Home, Office') }}">
            </div>

            <div class="form-group">
                <label class="form-label" for="address_line1">
                    {{ _("Address Line 1") }} *
                </label>
                <input type="text" id="address_line1" name="address_line1" class="form-control" required>
            </div>

            <div class="form-group">
                <label class="form-label" for="address_line2">
                    {{ _("Address Line 2") }}
                </label>
                <input type="text" id="address_line2" name="address_line2" class="form-control">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="city">
                        {{ _("City") }} *
                    </label>
                    <input type="text" id="city" name="city" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="state">
                        {{ _("State/Province") }} *
                    </label>
                    <input type="text" id="state" name="state" class="form-control" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="pincode">
                        {{ _("Postal Code") }} *
                    </label>
                    <input type="text" id="pincode" name="pincode" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="country">
                        {{ _("Country") }} *
                    </label>
                    <input type="text" id="country" name="country" class="form-control" value="Spain" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="address_phone">
                    {{ _("Phone") }}
                </label>
                <input type="tel" id="address_phone" name="phone" class="form-control">
            </div>

            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-lg);">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    {{ _("Save") }}
                </button>
                <button type="button" onclick="closeAddressModal()" class="btn btn-outline" style="flex: 1;">
                    {{ _("Cancel") }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showSection(sectionId, linkElement) {
    // Hide all sections
    document.querySelectorAll('.account-section-content').forEach(section => {
        section.style.display = 'none';
    });

    // Show selected section
    document.getElementById(sectionId + '-section').style.display = 'block';

    // Update menu active state
    document.querySelectorAll('.account-menu a').forEach(link => {
        link.classList.remove('active');
    });
    linkElement.classList.add('active');
}

async function payNow(orderId) {
    try {
        // Get CSRF token from meta tag or use server-side token
        const csrfToken = document.querySelector('meta[name="csrf_token"]')?.content || 
                         (typeof frappe !== 'undefined' ? frappe.csrf_token : null) || 
                         '{{ frappe.session.csrf_token }}';
        
        const response = await fetch('/api/method/garval_store.api.orders.get_payment_url', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': csrfToken
            },
            body: JSON.stringify({
                order_id: orderId
            })
        });

        const result = await response.json();
        if (result.message?.success && result.message?.payment_url) {
            window.location.href = result.message.payment_url;
        } else {
            throw new Error(result.message?.error || '{{ _("Error getting payment link") }}');
        }
    } catch (error) {
        alert(error.message || '{{ _("Error getting payment link") }}');
    }
}


// Profile form submit
document.getElementById('profileForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    try {
        const response = await fetch('/api/method/garval_store.api.auth.update_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': formData.get('csrf_token')
            },
            body: JSON.stringify({
                full_name: formData.get('full_name'),
                phone: formData.get('phone')
            })
        });

        const result = await response.json();
        if (result.message?.success) {
            GarvalStore.Forms.showMessage(this, 'success', '{{ _("Perfil actualizado") if lang == "es" else "Profile updated" }}');
        } else {
            throw new Error(result.message?.error);
        }
    } catch (error) {
        GarvalStore.Forms.showMessage(this, 'error', error.message || '{{ _("Error al guardar") if lang == "es" else "Save error" }}');
    }
});

// Password form submit
document.getElementById('passwordForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    if (formData.get('new_password') !== formData.get('confirm_new_password')) {
        GarvalStore.Forms.showMessage(this, 'error', '{{ _("Las contraseñas no coinciden") if lang == "es" else "Passwords do not match" }}');
        return;
    }

    try {
        const response = await fetch('/api/method/garval_store.api.auth.change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': formData.get('csrf_token')
            },
            body: JSON.stringify({
                current_password: formData.get('current_password'),
                new_password: formData.get('new_password')
            })
        });

        const result = await response.json();
        if (result.message?.success) {
            GarvalStore.Forms.showMessage(this, 'success', '{{ _("Contraseña cambiada") if lang == "es" else "Password changed" }}');
            this.reset();
        } else {
            throw new Error(result.message?.error);
        }
    } catch (error) {
        GarvalStore.Forms.showMessage(this, 'error', error.message || '{{ _("Error al cambiar contraseña") if lang == "es" else "Password change error" }}');
    }
});

// Address management functions
function openAddressModal(addressId = null) {
    const modal = document.getElementById('addressModal');
    const form = document.getElementById('addressForm');
    const title = document.getElementById('addressModalTitle');

    form.reset();
    document.getElementById('address_id').value = '';

    if (addressId) {
        title.textContent = '{{ _("Editar Dirección") if lang == "es" else "Edit Address" }}';
        // Load address data
        loadAddressData(addressId);
    } else {
        title.textContent = '{{ _("Nueva Dirección") if lang == "es" else "New Address" }}';
    }

    modal.style.display = 'flex';
}

function closeAddressModal() {
    document.getElementById('addressModal').style.display = 'none';
}

async function loadAddressData(addressId) {
    try {
        const response = await fetch(`/api/method/garval_store.api.address.get_address?address_id=${addressId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();
        if (result.message?.success) {
            const addr = result.message.address;
            document.getElementById('address_id').value = addr.name;
            document.getElementById('address_title').value = addr.address_title || '';
            document.getElementById('address_line1').value = addr.address_line1 || '';
            document.getElementById('address_line2').value = addr.address_line2 || '';
            document.getElementById('city').value = addr.city || '';
            document.getElementById('state').value = addr.state || '';
            document.getElementById('pincode').value = addr.pincode || '';
            document.getElementById('country').value = addr.country || 'Spain';
            document.getElementById('address_phone').value = addr.phone || '';
        }
    } catch (error) {
        // Silent fail - address data will be empty
    }
}

function editAddress(addressId) {
    openAddressModal(addressId);
}

async function deleteAddress(addressId) {
    const confirmMsg = '{{ _("¿Estás seguro de eliminar esta dirección?") if lang == "es" else "Are you sure you want to delete this address?" }}';
    if (!confirm(confirmMsg)) return;

    try {
        const response = await fetch('/api/method/garval_store.api.address.delete_address', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': '{{ frappe.session.csrf_token }}'
            },
            body: JSON.stringify({
                address_id: addressId
            })
        });

        const result = await response.json();
        if (result.message?.success) {
            // Remove the address card from DOM
            const card = document.querySelector(`[data-address-id="${addressId}"]`);
            if (card) {
                card.remove();
            }

            // Check if there are no addresses left
            const addressesList = document.getElementById('addressesList');
            if (addressesList.children.length === 0) {
                addressesList.innerHTML = `
                    <div class="empty-state" style="padding: var(--spacing-2xl); grid-column: 1 / -1;">
                        <div class="empty-state-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h3 class="empty-state-title">
                            {{ _("You have no saved addresses") }}
                        </h3>
                        <p class="empty-state-description">
                            {{ _("Add an address to make future purchases easier.") }}
                        </p>
                    </div>
                `;
            }

            alert('{{ _("Dirección eliminada") if lang == "es" else "Address deleted" }}');
        } else {
            throw new Error(result.message?.error || '{{ _("Error al eliminar dirección") if lang == "es" else "Error deleting address" }}');
        }
    } catch (error) {
        alert(error.message);
    }
}

// Address form submit
document.getElementById('addressForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const addressId = formData.get('address_id');

    const addressData = {
        address_title: formData.get('address_title'),
        address_line1: formData.get('address_line1'),
        address_line2: formData.get('address_line2'),
        city: formData.get('city'),
        state: formData.get('state'),
        pincode: formData.get('pincode'),
        country: formData.get('country'),
        phone: formData.get('phone')
    };

    try {
        const endpoint = addressId ? 'update_address' : 'create_address';
        if (addressId) {
            addressData.address_id = addressId;
        }

        const response = await fetch(`/api/method/garval_store.api.address.${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Frappe-CSRF-Token': formData.get('csrf_token')
            },
            body: JSON.stringify(addressData)
        });

        const result = await response.json();
        if (result.message?.success) {
            closeAddressModal();
            // Reload the page to show updated addresses
            window.location.reload();
        } else {
            throw new Error(result.message?.error || '{{ _("Error al guardar dirección") if lang == "es" else "Error saving address" }}');
        }
    } catch (error) {
        alert(error.message);
    }
});

// Handle hash navigation for deep linking to sections
window.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash.substring(1);
    if (hash && ['orders', 'profile', 'addresses'].includes(hash)) {
        const link = document.querySelector(`a[href="#${hash}"]`);
        if (link) {
            link.click();
        }
    }
});
</script>
{% endblock %}
