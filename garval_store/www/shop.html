{% extends "templates/includes/base.html" %}

{% block title %}{{ _("Finca Garval - Shop") }}{% endblock %}

{% block body_class %}shop-page{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="page-header-bg">
        <img src="/assets/garval_store/images/shop-header.jpg" alt="Shop">
        <div class="page-header-overlay"></div>
    </div>
    <div class="page-header-content">
        <h1 class="page-title">{{ _("Shop") }}</h1>
        <p class="page-breadcrumb">
            <a href="/home">{{ _("Home") }}</a> /
            <span>{{ _("Shop") }}</span>
        </p>
    </div>
</section>

<!-- Shop Section -->
<section class="shop-container">
    <div class="container">
        <!-- Shop Header with Filters -->
        <div class="shop-header">
            <div class="shop-results">
                <span>{{ _("Showing") }}</span>
                <strong>{{ products|length }}</strong>
                <span>{{ _("products") }}</span>
            </div>

            <div class="shop-filters">
                <!-- Sort -->
                <select id="sortProducts" class="filter-select">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>{{ _("Newest") }}</option>
                    <option value="price_low" {% if sort == 'price_low' %}selected{% endif %}>{{ _("Price: Low to High") }}</option>
                    <option value="price_high" {% if sort == 'price_high' %}selected{% endif %}>{{ _("Price: High to Low") }}</option>
                    <option value="name" {% if sort == 'name' %}selected{% endif %}>{{ _("Name: A-Z") }}</option>
                </select>

                <!-- Price Filter -->
                <div class="price-filter">
                    <input type="number" id="priceMin" placeholder="{{ _('Min') }}" value="{{ price_min or '' }}" min="0" step="0.01">
                    <span>-</span>
                    <input type="number" id="priceMax" placeholder="{{ _('Max') }}" value="{{ price_max or '' }}" min="0" step="0.01">
                    <button id="applyFilters" class="btn btn-outline" style="padding: 8px 16px;">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Grid -->
        {% if products %}
        <div class="products-grid">
            {% for product in products %}
            <div class="product-card" data-price="{{ product.price }}">
                <div class="product-image">
                    <a href="/product/{{ product.slug or product.item_code }}">
                        <img src="{{ product.image or '/assets/garval_store/images/product-placeholder.jpg' }}" alt="{{ product.name }}">
                    </a>
                    {% if product.out_of_stock %}
                    <span class="product-badge out-of-stock">{{ _("Out of Stock") }}</span>
                    {% endif %}
                </div>
                <div class="product-content">
                    <h3 class="product-title">
                        <a href="/product/{{ product.slug or product.item_code }}">{{ product.name }}</a>
                    </h3>
                    <div class="product-price">{{ product.formatted_price or currency_symbol + product.price|string }}</div>
                    <div class="product-actions">
                        {% if not product.out_of_stock %}
                        <button class="btn btn-primary"
                                data-add-to-cart="{{ product.item_code }}"
                                data-product-name="{{ product.name }}"
                                data-product-price="{{ product.price }}"
                                data-product-image="{{ product.image }}">
                            {{ _("Add to Cart") }}
                        </button>
                        {% else %}
                        <button class="btn btn-outline" disabled>{{ _("Unavailable") }}</button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- No Products -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-box-open"></i>
            </div>
            <h3 class="empty-state-title">{{ _("No products available") }}</h3>
            <p class="empty-state-description">{{ _("We'll be adding new products soon. Check back later!") }}</p>
            <a href="/home" class="btn btn-primary">{{ _("Back to Home") }}</a>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="pagination" style="margin-top: var(--spacing-2xl); display: flex; justify-content: center; gap: var(--spacing-sm);">
            {% if current_page > 1 %}
            <a href="?page={{ current_page - 1 }}" class="btn btn-outline">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}

            {% for page in range(1, total_pages + 1) %}
            <a href="?page={{ page }}" class="btn {% if page == current_page %}btn-primary{% else %}btn-outline{% endif %}">
                {{ page }}
            </a>
            {% endfor %}

            {% if current_page < total_pages %}
            <a href="?page={{ current_page + 1 }}" class="btn btn-outline">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Scroll to products section after page load if there are URL parameters (filter/search applied)
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);

    // Check if any filter parameters exist
    if (urlParams.has('sort') || urlParams.has('price_min') || urlParams.has('price_max') || urlParams.has('page')) {
        // Scroll to the shop container smoothly
        const shopContainer = document.querySelector('.shop-container');
        if (shopContainer) {
            setTimeout(() => {
                shopContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
});

// Handle sort and filter changes
document.getElementById('sortProducts')?.addEventListener('change', function() {
    const url = new URL(window.location);
    url.searchParams.set('sort', this.value);
    url.searchParams.delete('page'); // Reset to page 1
    window.location.href = url.toString();
});

document.getElementById('applyFilters')?.addEventListener('click', function() {
    const priceMin = document.getElementById('priceMin').value;
    const priceMax = document.getElementById('priceMax').value;

    const url = new URL(window.location);

    if (priceMin) {
        url.searchParams.set('price_min', priceMin);
    } else {
        url.searchParams.delete('price_min');
    }

    if (priceMax) {
        url.searchParams.set('price_max', priceMax);
    } else {
        url.searchParams.delete('price_max');
    }

    url.searchParams.delete('page'); // Reset to page 1
    window.location.href = url.toString();
});
</script>
{% endblock %}
